import React, { useState, useRef, useEffect } from 'react';
import { Camera, Upload, MapPin, Briefcase, RefreshCw, Download, ArrowRight, User, Loader2, Sparkles, Globe, Share2, Check } from 'lucide-react';

// API Configuration
// Defined at top level to ensure runtime injection works correctly
const apiKey = ""; 

const SilkRoadTraveler = () => {
  const [selectedImage, setSelectedImage] = useState(null);
  const [imageBase64, setImageBase64] = useState(null);
  const [generatedImage, setGeneratedImage] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [selectedRole, setSelectedRole] = useState('');
  const [selectedCity, setSelectedCity] = useState('');
  const [loadingStep, setLoadingStep] = useState('');
  const [lang, setLang] = useState('en'); // 'en' or 'zh'
  const [copied, setCopied] = useState(false);

  // Content Dictionary
  const content = {
    en: {
      title: "Silk Road Time Traveler",
      subtitle: "Experience the Han Dynasty Trade Route",
      quote: "\"The journey of a thousand miles begins with a single step.\"",
      step1: "Upload Your Portrait",
      step1Desc: "Click or Drop a photo here",
      step1Sub: "Use a clear selfie for best results",
      step2: "Choose Your Profession",
      step3: "Select Destination",
      readyTitle: "Ready to Travel?",
      readyText: (city, role) => `Traveling to ${city} as a ${role}...`,
      readyDefault: "Complete the steps on the left to begin.",
      btnGenerate: "Travel Now",
      btnProcessing: "Processing...",
      btnDownload: "Save Souvenir",
      btnReset: "New Journey",
      btnShare: "Share App",
      linkCopied: "Link Copied!",
      loading1: "Preparing caravan...",
      loading2: "Crossing the desert...",
      loading3: "Arriving at destination...",
      errorSize: "Image size too large. Please upload an image under 5MB.",
      errorMissing: "Please select an image, a role, and a destination.",
      errorGen: "The caravan got lost in a sandstorm! Please try again.",
      originalImg: "Original Image",
      placeholderTitle: "Your historical portrait will appear here",
      placeholderText: "Select a role and location, then upload your photo to see yourself in the Han Dynasty.",
      didYouKnow: "Did you know?",
      factIntro: (role, city) => `As a ${role} in ${city}, `,
      factEnding: "you would likely interact with people speaking completely different languages. Merchants often used hand signals or translators to trade"
    },
    zh: {
      title: "ä¸ç»¸ä¹‹è·¯ç©¿è¶Šè€…",
      subtitle: "ä½“éªŒæ±‰ä»£å•†è´¸ä¹‹æ—…",
      quote: "â€œåƒé‡Œä¹‹è¡Œï¼Œå§‹äºŽè¶³ä¸‹ã€‚â€",
      step1: "ä¸Šä¼ æ‚¨çš„è‚–åƒ",
      step1Desc: "ç‚¹å‡»æˆ–æ‹–æ”¾ç…§ç‰‡è‡³æ­¤å¤„",
      step1Sub: "è¯·ä½¿ç”¨æ¸…æ™°çš„è‡ªæ‹ä»¥èŽ·å¾—æœ€ä½³æ•ˆæžœ",
      step2: "é€‰æ‹©æ‚¨çš„èº«ä»½",
      step3: "é€‰æ‹©ç›®çš„åœ°",
      readyTitle: "å‡†å¤‡å‡ºå‘ï¼Ÿ",
      readyText: (city, role) => `ä½œä¸º${role}å‰å¾€${city}...`,
      readyDefault: "è¯·å®Œæˆå·¦ä¾§æ­¥éª¤ä»¥å¼€å§‹ã€‚",
      btnGenerate: "ç«‹å³ç©¿è¶Š",
      btnProcessing: "å¤„ç†ä¸­...",
      btnDownload: "ä¿å­˜çºªå¿µ",
      btnReset: "å¼€å¯æ–°æ—…ç¨‹",
      btnShare: "åˆ†äº«åº”ç”¨",
      linkCopied: "é“¾æŽ¥å·²å¤åˆ¶ï¼",
      loading1: "æ­£åœ¨æ•´é¡¿å•†é˜Ÿ...",
      loading2: "æ­£åœ¨ç©¿è¶Šæ²™æ¼ ...",
      loading3: "å³å°†æŠµè¾¾ç›®çš„åœ°...",
      errorSize: "å›¾ç‰‡è¿‡å¤§ï¼Œè¯·ä¸Šä¼ 5MBä»¥ä¸‹çš„å›¾ç‰‡ã€‚",
      errorMissing: "è¯·é€‰æ‹©å›¾ç‰‡ã€èº«ä»½å’Œç›®çš„åœ°ã€‚",
      errorGen: "å•†é˜Ÿåœ¨æ²™å°˜æš´ä¸­è¿·å¤±äº†æ–¹å‘ï¼è¯·é‡è¯•ã€‚",
      originalImg: "åŽŸå§‹å›¾ç‰‡",
      placeholderTitle: "æ‚¨çš„åŽ†å²ç”»åƒå°†å‡ºçŽ°åœ¨è¿™é‡Œ",
      placeholderText: "é€‰æ‹©èº«ä»½å’Œåœ°ç‚¹ï¼Œä¸Šä¼ ç…§ç‰‡ï¼Œç©¿è¶Šå›žæ±‰ä»£ã€‚",
      didYouKnow: "åŽ†å²å°çŸ¥è¯†",
      factIntro: (role, city) => `èº«ä¸º${city}çš„ä¸€å${role}ï¼Œ`,
      factEnding: "æ‚¨å¯èƒ½ä¼šé‡åˆ°è¯­è¨€ä¸é€šçš„å¼‚å›½å•†äººã€‚å½“æ—¶çš„äº¤æ˜“å¾€å¾€ä¾èµ–æ‰‹åŠ¿æˆ–ç¿»è¯‘ï¼Œä»¥æ­¤äº¤æ¢"
    }
  };

  const roles = [
    { 
      id: 'han_trader', 
      label: { en: 'Han Official Trader', zh: 'æ±‰æœä½¿èŠ‚' },
      icon: 'ðŸ“œ', 
      desc: { en: 'An official envoy of the Han Dynasty managing government tributes.', zh: 'ç®¡ç†æœå»·è´¡å“çš„æ±‰ä»£å®˜æ–¹ä½¿èŠ‚ã€‚' },
      prompt_modifier: 'wearing elegant Han Dynasty silk robes (Shenyi) with a formal headdress, holding a bamboo scroll',
      factFragment: { 
        en: ' diplomatic gifts to ensure safe passage.', 
        zh: ' ç¡®ä¿é€šè¡Œçš„å¤–äº¤ç¤¼ç‰©ã€‚' 
      }
    },
    { 
      id: 'silk_merchant', 
      label: { en: 'Silk Businessman', zh: 'ä¸ç»¸å•†äºº' },
      icon: 'ðŸ‘˜', 
      desc: { en: 'A wealthy merchant dealing in the finest sericulture products.', zh: 'ç»è¥ä¸Šç­‰ä¸ç»‡å“çš„å¯Œå•†ã€‚' },
      prompt_modifier: 'wearing luxurious, colorful patterned silk robes, holding a bolt of fine silk fabric',
      factFragment: { 
        en: ' precious silk bolts for horses or jade.', 
        zh: ' çè´µçš„ä¸ç»¸ä»¥æ¢å–é©¬åŒ¹æˆ–çŽ‰çŸ³ã€‚' 
      }
    },
    { 
      id: 'jade_vendor', 
      label: { en: 'Jade Vendor', zh: 'çŽ‰çŸ³å•†äºº' },
      icon: 'ðŸ“¿', 
      desc: { en: 'An artisan trading precious stones believed to bring immortality.', zh: 'äº¤æ˜“è±¡å¾é•¿ç”Ÿä¸è€çš„çè´µçŽ‰çŸ³ã€‚' },
      prompt_modifier: 'wearing practical Han merchant attire, holding a glowing green jade carving, wearing jade jewelry',
      factFragment: { 
        en: ' carved stones that symbolized moral integrity and immortality.', 
        zh: ' è±¡å¾å“å¾·ä¸Žæ°¸ç”Ÿçš„çŽ‰é›•ã€‚' 
      }
    },
    { 
      id: 'tea_vendor', 
      label: { en: 'Tea Master', zh: 'èŒ¶åº„ä¸»äºº' },
      icon: 'ðŸµ', 
      desc: { en: 'A purveyor of compressed tea bricks for the long journey.', zh: 'ä¸ºé•¿é€”è·‹æ¶‰æä¾›ç´§åŽ‹èŒ¶ç –çš„èŒ¶å•†ã€‚' },
      prompt_modifier: 'wearing earth-toned linen robes, holding a tea brick or ancient ceramic tea bowl, steam rising',
      factFragment: { 
        en: ' compressed tea bricks that were sometimes used as currency.', 
        zh: ' æœ‰æ—¶è¢«ç”¨ä½œè´§å¸çš„ç´§åŽ‹èŒ¶ç –ã€‚' 
      }
    },
    { 
      id: 'spice_vendor', 
      label: { en: 'Spice Vendor', zh: 'é¦™æ–™å•†è´©' },
      icon: 'ðŸŒ¶ï¸', 
      desc: { en: 'A trader of exotic aromatics from the far west.', zh: 'è´©å–æ¥è‡ªé¥è¿œè¥¿æ–¹çš„å¼‚åŸŸé¦™æ–™ã€‚' },
      prompt_modifier: 'wearing layered traveling robes with a turban or headwrap, holding a basket of colorful spices (saffron, pepper)',
      factFragment: { 
        en: ' aromatic spices worth more than their weight in gold.', 
        zh: ' ä»·æ¯”é»„é‡‘çš„çç¨€é¦™æ–™ã€‚' 
      }
    },
  ];

  const cities = [
    { 
      id: 'changan', 
      label: { en: "Chang'an", zh: "é•¿å®‰" },
      sub: { en: 'The Starting Point', zh: 'ä¸è·¯èµ·ç‚¹' },
      desc: { en: "The magnificent capital of the Han Dynasty and the world's largest city at the time.", zh: "æ±‰ä»£å®ä¼Ÿçš„éƒ½åŸŽï¼Œä¹Ÿæ˜¯å½“æ—¶ä¸–ç•Œä¸Šæœ€å¤§çš„åŸŽå¸‚ã€‚" },
      bg_prompt: 'the bustling ancient capital city of Chang\'an, Han Dynasty architecture, large wooden pagodas, busy market streets'
    },
    { 
      id: 'dunhuang', 
      label: { en: 'Dunhuang', zh: 'æ•¦ç…Œ' },
      sub: { en: 'Gateway to the West', zh: 'è¥¿åŸŸé—¨æˆ·' },
      desc: { en: "A vital oasis town on the edge of the Taklamakan Desert, famous for its caves.", zh: "å¡”å…‹æ‹‰çŽ›å¹²æ²™æ¼ è¾¹ç¼˜çš„é‡è¦ç»¿æ´²ï¼Œä»¥çŸ³çªŸé—»åã€‚" },
      bg_prompt: 'the ancient oasis city of Dunhuang, edge of the desert, sand dunes in background, camel caravans, Mogao caves visible'
    },
    { 
      id: 'kashgar', 
      label: { en: 'Kashgar', zh: 'å–€ä»€' },
      sub: { en: 'The Crossroads', zh: 'ä¸è·¯äº¤æ±‡' },
      desc: { en: "Where the Northern and Southern Silk Road routes meet at the foot of the Pamir Mountains.", zh: "ä¸ç»¸ä¹‹è·¯å—åŒ—ä¸¤é“åœ¨å¸•ç±³å°”é«˜åŽŸè„šä¸‹çš„äº¤æ±‡ç‚¹ã€‚" },
      bg_prompt: 'the ancient bazaar of Kashgar, mud-brick architecture, rugged mountains in distance, diverse crowd of traders'
    },
    { 
      id: 'samarkand', 
      label: { en: 'Samarkand', zh: 'æ’’é©¬å°”ç½•' },
      sub: { en: 'Jewel of the Road', zh: 'ä¸è·¯æ˜Žç ' },
      desc: { en: "A central hub of trade renowned for its gardens and Sogdian merchants.", zh: "ä»¥èŠ±å›­å’Œç²Ÿç‰¹å•†äººé—»åçš„è´¸æ˜“ä¸­å¿ƒã€‚" },
      bg_prompt: 'ancient Samarkand, grand central asian architecture, blue domes, lush gardens, busy caravan stop'
    },
    { 
      id: 'constantinople', 
      label: { en: 'Constantinople', zh: 'å›å£«å¦ä¸å ¡' },
      sub: { en: 'The Western End', zh: 'è¥¿æ–¹ç»ˆç‚¹' },
      desc: { en: "The great capital of the Byzantine Empire, the bridge between Asia and Europe.", zh: "æ‹œå åº­å¸å›½çš„ä¼Ÿå¤§é¦–éƒ½ï¼Œè¿žæŽ¥äºšæ¬§å¤§é™†çš„æ¡¥æ¢ã€‚" },
      bg_prompt: 'ancient Constantinople (Byzantium), roman architecture, hagia sophia style domes, mediterranean coast, marble streets'
    },
  ];

  const handleImageUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        setError(content[lang].errorSize);
        return;
      }
      
      const reader = new FileReader();
      reader.onloadend = () => {
        setSelectedImage(reader.result);
        const base64Data = reader.result.split(',')[1];
        const mimeType = reader.result.split(';')[0].split(':')[1];
        setImageBase64({ data: base64Data, mimeType });
        setError('');
        setGeneratedImage(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleShare = () => {
    // Try to get the actual URL from the top window (if inside an iframe)
    // If blocked by cross-origin policies, fall back to current location
    let url = window.location.href;
    try {
      if (window.top !== window.self) {
        url = window.top.location.href;
      }
    } catch (e) {
      // Cross-origin access denied, sticking to window.location.href
      console.log('Using fallback URL due to iframe restrictions');
    }

    const textArea = document.createElement("textarea");
    textArea.value = url;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy', err);
    }
    document.body.removeChild(textArea);
  };

  const handleGenerate = async () => {
    if (!imageBase64 || !selectedRole || !selectedCity) {
      setError(content[lang].errorMissing);
      return;
    }

    setLoading(true);
    setError('');
    setGeneratedImage(null);

    const roleData = roles.find(r => r.id === selectedRole);
    const cityData = cities.find(c => c.id === selectedCity);

    try {
      setLoadingStep(content[lang].loading1);
      
      // Keep prompt in English for best AI performance
      const prompt = `Transform the person in this image into a historical ${roleData.label.en} in ancient ${cityData.label.en} (Silk Road era). 
      Keep the person's facial features recognizable but change their clothing to be ${roleData.prompt_modifier}. 
      The background should be ${cityData.bg_prompt}. 
      The style should be a high-quality, cinematic historical portrait. Photorealistic, detailed texture.`;

      setLoadingStep(content[lang].loading2);

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: prompt },
              { 
                inlineData: { 
                  mimeType: imageBase64.mimeType, 
                  data: imageBase64.data 
                } 
              }
            ]
          }],
          generationConfig: {
            responseModalities: ["IMAGE"],
          }
        })
      });

      if (!response.ok) {
        // Robust error handling for non-JSON or empty error responses
        let errorMsg = `API Error: ${response.status} ${response.statusText}`;
        
        // Handle specific 401 error
        if (response.status === 401) {
            errorMsg = "API Key Invalid or Missing (401). The environment may not have injected the key correctly.";
        } else {
            try {
              const errorText = await response.text();
              if (errorText) {
                try {
                  const errorJson = JSON.parse(errorText);
                  if (errorJson.error?.message) {
                    errorMsg = errorJson.error.message;
                  }
                } catch {
                  // If response is text (like 404 html), just append if short
                  if (errorText.length < 500) errorMsg += `: ${errorText}`;
                }
              }
            } catch (e) {
                // ignore fetch text error
            }
        }
        throw new Error(errorMsg);
      }

      setLoadingStep(content[lang].loading3);
      const data = await response.json();
      
      if (data.candidates && data.candidates[0]?.content?.parts) {
        const imagePart = data.candidates[0].content.parts.find(p => p.inlineData);
        if (imagePart) {
          const newImageUrl = `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`;
          setGeneratedImage(newImageUrl);
        } else {
          throw new Error("No image generated.");
        }
      } else {
        throw new Error("Invalid response format.");
      }

    } catch (err) {
      console.error(err);
      setError(content[lang].errorGen + ` (${err.message})`);
    } finally {
      setLoading(false);
      setLoadingStep('');
    }
  };

  const resetAll = () => {
    setSelectedImage(null);
    setImageBase64(null);
    setGeneratedImage(null);
    setSelectedRole('');
    setSelectedCity('');
    setError('');
  };

  const toggleLang = () => {
    setLang(prev => prev === 'en' ? 'zh' : 'en');
  };

  return (
    <div className="min-h-screen bg-stone-100 font-sans text-stone-800">
      {/* Header */}
      <header className="bg-amber-900 text-amber-50 p-6 shadow-lg border-b-4 border-amber-700">
        <div className="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-amber-100 p-2 rounded-full">
              <img src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f42a.png" alt="Camel" className="w-8 h-8" />
            </div>
            <div>
              <h1 className="text-2xl font-bold tracking-wide">{content[lang].title}</h1>
              <p className="text-amber-200 text-sm">{content[lang].subtitle}</p>
            </div>
          </div>
          <div className="flex flex-col items-end gap-2 mt-4 md:mt-0">
            <div className="flex gap-2">
              <button 
                onClick={handleShare}
                className={`flex items-center gap-2 text-xs px-3 py-1 rounded-full transition-all border ${
                  copied 
                    ? 'bg-green-700 border-green-500 text-white' 
                    : 'bg-amber-800 hover:bg-amber-700 border-amber-600 text-amber-50'
                }`}
              >
                {copied ? <Check className="w-3 h-3" /> : <Share2 className="w-3 h-3" />}
                {copied ? content[lang].linkCopied : content[lang].btnShare}
              </button>
              <button 
                onClick={toggleLang}
                className="flex items-center gap-2 bg-amber-800 hover:bg-amber-700 text-xs px-3 py-1 rounded-full transition-colors border border-amber-600"
              >
                <Globe className="w-3 h-3" />
                {lang === 'en' ? 'ä¸­æ–‡' : 'English'}
              </button>
            </div>
            <div className="text-amber-200 text-sm italic">
              {content[lang].quote}
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-4 md:p-8">
        
        {error && (
          <div className="mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm flex items-center justify-between">
            <p>{error}</p>
            <button onClick={() => setError('')} className="text-red-500 hover:text-red-700 font-bold">&times;</button>
          </div>
        )}

        {/* Main Interface Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* LEFT COLUMN: Controls */}
          <div className="lg:col-span-5 space-y-8">
            
            {/* Step 1: Upload */}
            <section className="bg-white rounded-xl shadow-md p-6 border border-stone-200">
              <h2 className="text-xl font-bold text-amber-900 flex items-center gap-2 mb-4">
                <span className="bg-amber-100 text-amber-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                {content[lang].step1}
              </h2>
              
              {!selectedImage ? (
                <div className="border-2 border-dashed border-stone-300 rounded-lg p-8 text-center hover:bg-stone-50 transition-colors relative cursor-pointer group">
                  <input 
                    type="file" 
                    accept="image/*" 
                    onChange={handleImageUpload} 
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  />
                  <div className="flex flex-col items-center gap-2 text-stone-500 group-hover:text-amber-700">
                    <Camera className="w-12 h-12" />
                    <p className="font-medium">{content[lang].step1Desc}</p>
                    <p className="text-xs">{content[lang].step1Sub}</p>
                  </div>
                </div>
              ) : (
                <div className="relative rounded-lg overflow-hidden border border-stone-200 bg-stone-100">
                  <img src={selectedImage} alt="Uploaded" className="w-full h-48 object-cover" />
                  <button 
                    onClick={() => { setSelectedImage(null); setGeneratedImage(null); }}
                    className="absolute top-2 right-2 bg-white/90 p-2 rounded-full text-stone-600 hover:text-red-500 shadow-sm"
                  >
                    <RefreshCw className="w-4 h-4" />
                  </button>
                  <div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs p-2 text-center">
                    {content[lang].originalImg}
                  </div>
                </div>
              )}
            </section>

            {/* Step 2: Role */}
            <section className="bg-white rounded-xl shadow-md p-6 border border-stone-200">
              <h2 className="text-xl font-bold text-amber-900 flex items-center gap-2 mb-4">
                <span className="bg-amber-100 text-amber-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                {content[lang].step2}
              </h2>
              <div className="grid grid-cols-1 gap-3">
                {roles.map((role) => (
                  <button
                    key={role.id}
                    onClick={() => setSelectedRole(role.id)}
                    className={`flex items-start text-left p-3 rounded-lg border transition-all ${
                      selectedRole === role.id 
                        ? 'bg-amber-50 border-amber-500 ring-1 ring-amber-500 shadow-sm' 
                        : 'bg-white border-stone-200 hover:border-amber-300 hover:bg-stone-50'
                    }`}
                  >
                    <span className="text-2xl mr-3 bg-white p-1 rounded shadow-sm">{role.icon}</span>
                    <div>
                      <div className="font-bold text-stone-800">{role.label[lang]}</div>
                      <div className="text-xs text-stone-500 mt-1">{role.desc[lang]}</div>
                    </div>
                  </button>
                ))}
              </div>
            </section>

            {/* Step 3: Location */}
            <section className="bg-white rounded-xl shadow-md p-6 border border-stone-200">
              <h2 className="text-xl font-bold text-amber-900 flex items-center gap-2 mb-4">
                <span className="bg-amber-100 text-amber-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">3</span>
                {content[lang].step3}
              </h2>
              <div className="space-y-3">
                {cities.map((city) => (
                  <button
                    key={city.id}
                    onClick={() => setSelectedCity(city.id)}
                    className={`w-full flex flex-col text-left p-3 rounded-lg border transition-all ${
                      selectedCity === city.id 
                        ? 'bg-amber-50 border-amber-500 ring-1 ring-amber-500 shadow-sm' 
                        : 'bg-white border-stone-200 hover:border-amber-300 hover:bg-stone-50'
                    }`}
                  >
                    <div className="flex justify-between items-center w-full">
                      <div className="font-bold text-stone-800">{city.label[lang]}</div>
                      <div className="text-xs font-semibold text-amber-700 bg-amber-100 px-2 py-0.5 rounded">{city.sub[lang]}</div>
                    </div>
                    <div className="text-xs text-stone-500 mt-1">{city.desc[lang]}</div>
                  </button>
                ))}
              </div>
            </section>

          </div>

          {/* RIGHT COLUMN: Action & Result */}
          <div className="lg:col-span-7 flex flex-col gap-8">
            
            {/* Generate Button Area */}
            <div className="bg-gradient-to-r from-amber-700 to-amber-900 rounded-xl p-6 shadow-lg text-white flex flex-col sm:flex-row items-center justify-between gap-4">
              <div>
                <h3 className="font-bold text-lg">{content[lang].readyTitle}</h3>
                <p className="text-amber-200 text-sm">
                  {selectedRole && selectedCity 
                    ? content[lang].readyText(cities.find(c => c.id === selectedCity).label[lang], roles.find(r => r.id === selectedRole).label[lang])
                    : content[lang].readyDefault}
                </p>
              </div>
              <button
                onClick={handleGenerate}
                disabled={loading || !selectedImage || !selectedRole || !selectedCity}
                className={`px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 transition-all transform ${
                  loading || !selectedImage || !selectedRole || !selectedCity
                    ? 'bg-stone-600 text-stone-400 cursor-not-allowed opacity-50'
                    : 'bg-yellow-500 text-amber-950 hover:bg-yellow-400 hover:scale-105 active:scale-95'
                }`}
              >
                {loading ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    {content[lang].btnProcessing}
                  </>
                ) : (
                  <>
                    <Sparkles className="w-5 h-5" />
                    {content[lang].btnGenerate}
                  </>
                )}
              </button>
            </div>

            {/* Main Canvas Area */}
            <div className="flex-grow bg-white rounded-xl shadow-lg border border-stone-200 p-4 md:p-8 min-h-[500px] flex flex-col relative overflow-hidden">
              
              {/* Background Decoration */}
              <div className="absolute inset-0 opacity-5 pointer-events-none" style={{
                backgroundImage: 'url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%239C92AC\' fill-opacity=\'0.4\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")'
              }}></div>

              {loading ? (
                <div className="flex-1 flex flex-col items-center justify-center text-center animate-pulse gap-6">
                  <div className="relative">
                    <div className="absolute inset-0 bg-amber-200 rounded-full animate-ping opacity-20"></div>
                    <img src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f42a.png" alt="Camel" className="w-20 h-20 animate-bounce" />
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-amber-800">{content[lang].loading1}</h3>
                    <p className="text-stone-500 mt-2 font-mono text-sm">{loadingStep}</p>
                  </div>
                </div>
              ) : generatedImage ? (
                <div className="flex-1 flex flex-col h-full">
                  <div className="flex-1 relative rounded-lg overflow-hidden shadow-xl border-4 border-amber-900 bg-stone-900 group">
                    <img src={generatedImage} alt="Generated History" className="w-full h-full object-contain" />
                    
                    {/* Overlay Info Card */}
                    <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-6 text-white transform translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300">
                      <div className="font-bold text-xl">{roles.find(r => r.id === selectedRole)?.label[lang]}</div>
                      <div className="text-amber-300 text-sm flex items-center gap-1">
                        <MapPin className="w-3 h-3" />
                        {cities.find(c => c.id === selectedCity)?.label[lang]}
                      </div>
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="mt-6 flex justify-center gap-4">
                    <a 
                      href={generatedImage} 
                      download={`silk-road-${selectedRole}-${selectedCity}.png`}
                      className="flex items-center gap-2 bg-stone-800 text-white px-6 py-3 rounded-full hover:bg-stone-700 transition-colors shadow-md"
                    >
                      <Download className="w-4 h-4" />
                      {content[lang].btnDownload}
                    </a>
                    <button 
                      onClick={resetAll}
                      className="flex items-center gap-2 bg-stone-200 text-stone-700 px-6 py-3 rounded-full hover:bg-stone-300 transition-colors shadow-md"
                    >
                      <RefreshCw className="w-4 h-4" />
                      {content[lang].btnReset}
                    </button>
                  </div>
                </div>
              ) : (
                <div className="flex-1 flex flex-col items-center justify-center text-stone-300">
                  <div className="w-32 h-32 border-4 border-dashed border-stone-200 rounded-full flex items-center justify-center mb-4">
                    <User className="w-12 h-12" />
                  </div>
                  <p className="text-lg font-medium text-stone-400">{content[lang].placeholderTitle}</p>
                  <p className="text-sm text-stone-300 max-w-md text-center mt-2">
                    {content[lang].placeholderText}
                  </p>
                </div>
              )}
            </div>

            {/* Fact Box */}
            {selectedCity && selectedRole && !loading && (
              <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-4">
                <div className="bg-white p-2 rounded-full shadow-sm text-2xl">ðŸ’¡</div>
                <div>
                  <h4 className="font-bold text-amber-900 text-sm uppercase tracking-wide mb-1">{content[lang].didYouKnow}</h4>
                  <p className="text-stone-700 text-sm leading-relaxed">
                    {content[lang].factIntro(roles.find(r => r.id === selectedRole).label[lang], cities.find(c => c.id === selectedCity).label[lang])} 
                    {content[lang].factEnding}
                    <strong>{roles.find(r => r.id === selectedRole).factFragment[lang]}</strong>
                  </p>
                </div>
              </div>
            )}

          </div>
        </div>
      </main>
    </div>
  );
};

export default SilkRoadTraveler;